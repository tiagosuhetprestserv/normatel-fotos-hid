<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Foto com GPS, Data e Troca de CÃ¢mera</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/distdy {
      font-family: sans-serif;
      text-align: center;
      padding: 10px;
    }
    video, canvas, #mapa {
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
    }
    #mapa {
      height: 300px;
      margin-top: 15px;
    }
    .controls {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    button, a {
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background-color: #0078D4;
      color: white;
      text-decoration: none;
      cursor: pointer;
    }
    button:hover, a:hover {
      background-color: #005A9E;
    }
    #localizacao, #infoTexto {
      margin-top: 15px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Captura de EvidÃªncia com GPS e Data</h2>
  <video id="video" autoplay playsinline></video>

  <div class="controls">
    <button onclick="trocarCamera()">ğŸ”„ Trocar CÃ¢mera</button>
    <button onclick="tirarFoto()">ğŸ“¸ Tirar Foto</button>
    <a id="downloadLink" style="display:none;">â¬‡ï¸ Baixar Foto</a>
    <button onclick="compartilharFoto()" id="shareBtn" style="display:none;">ğŸ“¤ Compartilhar</button>
  </div>

  <canvas id="canvas"></canvas>
  <p id="localizacao">ğŸ“ LocalizaÃ§Ã£o: (aguardando...)</p>
  <p id="infoTexto" style="display:none;"></p>
  <div id="mapa"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></onst video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const localizacao = document.getElementById('localizacao');
    const infoTexto = document.getElementById('infoTexto');
    const downloadLink = document.getElementById('downloadLink');
    const shareBtn = document.getElementById('shareBtn');
    let usandoFrontal = true;
    let streamAtual = null;

    let latitudeGlobal = "";
    let longitudeGlobal = "";
    let dataHoraGlobal = "";

    let mapa;
    let marcador;

    async function iniciarCamera() {
      if (streamAtual) {
        streamAtual.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: {
          facingMode: usandoFrontal ? "user" : "environment"
        }
      };

      try {
        streamAtual = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = streamAtual;

        await new Promise(resolve => {
          video.onloadedmetadata = () => {
            video.play();
            resolve();
          };
        });
      } catch (err) {
        alert("Erro ao acessar cÃ¢mera: " + err);
      }
    }

    function trocarCamera() {
      usandoFrontal = !usandoFrontal;
      iniciarCamera();
    }

    function atualizarMapa(lat, lng) {
      const coordenadas = [parseFloat(lat), parseFloat(lng)];

      if (!mapa) {
        mapa = L.map('mapa').setView(coordenadas, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap',
        }).addTo(mapa);

        marcador = L.marker(coordenadas).addTo(mapa)
          .bindPopup(`ğŸ“ LocalizaÃ§Ã£o: ${lat}, ${lng}`)
          .openPopup();
      } else {
        mapa.setView(coordenadas, 15);
        marcador.setLatLng(coordenadas)
          .setPopupContent(`ğŸ“ LocalizaÃ§Ã£o: ${lat}, ${lng}`)
          .openPopup();
      }
    }

    function tirarFoto() {
      if (!video.videoWidth || !video.videoHeight) {
        alert("CÃ¢mera ainda nÃ£o estÃ¡ pronta. Tente novamente.");
        return;
      }

      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      navigator.geolocation.getCurrentPosition(pos => {
        latitudeGlobal = pos.coords.latitude.toFixed(6);
        longitudeGlobal = pos.coords.longitude.toFixed(6);
        const agora = new Date();
        dataHoraGlobal = agora.toLocaleString('pt-BR');

        localizacao.textContent = `ğŸ“ LocalizaÃ§Ã£o: ${latitudeGlobal}, ${longitudeGlobal}`;

        ctx.font = "20px Arial";
        ctx.fillStyle = "yellow";
        let y = canvas.height - 60;
        ctx.fillText(`Lat: ${latitudeGlobal}`, 10, y);
        ctx.fillText(`Lng: ${longitudeGlobal}`, 10, y + 25);
        ctx.fillText(`ğŸ•’ ${dataHoraGlobal}`, 10, y + 50);

        const imagem = canvas.toDataURL("image/png");
        downloadLink.href = imagem;
        downloadLink.download = `foto_${dataHoraGlobal.replace(/[\/: ]/g, "_")}.png`;
        downloadLink.textContent = "â¬‡ï¸ Baixar Foto";
        downloadLink.style.display = 'inline-block';

        shareBtn.style.display = 'inline-block';

        infoTexto.innerHTML = `
          <strong>ğŸ“ LocalizaÃ§Ã£o:</strong> ${latitudeGlobal}, ${longitudeGlobal}<br>
          <strong>ğŸ•’ Data e Hora:</strong> ${dataHoraGlobal}
        `;
        infoTexto.style.display = 'block';

        atualizarMapa(latitudeGlobal, longitudeGlobal);
      }, err => {
        alert("Erro ao obter localizaÃ§Ã£o: " + err.message);
      });
    }

    function compartilharFoto() {
      canvas.toBlob(async blob => {
        const file = new File([blob], `foto_${dataHoraGlobal.replace(/[\/: ]/g, "_")}.png`, { type: "image/png" });

        const texto = `ğŸ“ LocalizaÃ§Ã£o: ${latitudeGlobal}, ${longitudeGlobal}\nğŸ•’ Data e Hora: ${dataHoraGlobal}`;

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({
              title: "EvidÃªncia com GPS",
              text: texto,
              files: [file]
            });
          } catch (err) {
            alert("Erro ao compartilhar: " + err);
          }
        } else {
          alert("Compartilhamento com arquivos nÃ£o Ã© suportado neste navegador. Baixe a imagem e compartilhe manualmente.");
        }
      }, 'image/png');
    }

    function iniciarMapaInicial() {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        atualizarMapa(lat, lng);
        localizacao.textContent = `ğŸ“ LocalizaÃ§Ã£o: ${lat}, ${lng}`;
      }, err => {
        alert("Erro ao obter localizaÃ§Ã£o inicial: " + err.message);
      });
    }

    iniciarCamera();
    iniciarMapaInicial();
  </script>
</body>
</html>
